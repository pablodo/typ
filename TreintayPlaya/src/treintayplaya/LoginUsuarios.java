/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * LoginUsuarios.java
 *
 * Created on 11-oct-2011, 10:08:20
 */
package treintayplaya;


/**
 *
 * @author sergio
 */
public class LoginUsuarios extends javax.swing.JInternalFrame {

    String    usrPass;
    int       usrNivel, usrEstado, usrID;

        /** Creates new form LoginUsuarios */
    public LoginUsuarios() {
        initComponents();
        getRootPane().setDefaultButton(jbtnLogin);
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jlblUsuario = new javax.swing.JLabel();
        jlblPass = new javax.swing.JLabel();
        jtxfUsuario = new javax.swing.JTextField();
        jpfPass = new javax.swing.JPasswordField();
        jbtnLogin = new javax.swing.JButton();
        jbtnRegistrar = new javax.swing.JButton();
        jbtnCancelar = new javax.swing.JButton();

        setTitle("Iniciar Sesión");
        setName("");

        jlblUsuario.setText("Usuario:");

        jlblPass.setText("Contraseña:");

        jtxfUsuario.setToolTipText("Dirección de Correo Electrónico");

        jbtnLogin.setMnemonic('A');
        jbtnLogin.setText("Acceder");
        jbtnLogin.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbtnLoginActionPerformed(evt);
            }
        });

        jbtnRegistrar.setMnemonic('R');
        jbtnRegistrar.setText("Registrar");
        jbtnRegistrar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbtnRegistrarActionPerformed(evt);
            }
        });

        jbtnCancelar.setMnemonic('C');
        jbtnCancelar.setText("Cancelar");
        jbtnCancelar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbtnCancelarActionPerformed(evt);
            }
        });

        org.jdesktop.layout.GroupLayout layout = new org.jdesktop.layout.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(layout.createSequentialGroup()
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
                    .add(layout.createSequentialGroup()
                        .addContainerGap()
                        .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING, false)
                            .add(jlblPass, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .add(jlblUsuario, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                        .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                            .add(jpfPass, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 289, Short.MAX_VALUE)
                            .add(jtxfUsuario)))
                    .add(layout.createSequentialGroup()
                        .add(79, 79, 79)
                        .add(jbtnLogin)
                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                        .add(jbtnRegistrar)
                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                        .add(jbtnCancelar)))
                .addContainerGap(44, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(layout.createSequentialGroup()
                .addContainerGap()
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jlblUsuario)
                    .add(jtxfUsuario, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .add(18, 18, 18)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jlblPass)
                    .add(jpfPass, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED, 23, Short.MAX_VALUE)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jbtnLogin)
                    .add(jbtnRegistrar)
                    .add(jbtnCancelar))
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jbtnLoginActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbtnLoginActionPerformed

        if((jtxfUsuario.getText().length() > 0) && (jpfPass.getPassword().length > 0)) {
            try {
                java.sql.Connection cnx = Conexion.getInstance().getConnection();

                java.sql.PreparedStatement pstm = cnx.prepareStatement("select usrID, usrNivel, usrActivo from UsuariosWeb where usrEmail = ? and AES_DECRYPT(usrPass, 'typ2012') = ?") ;

                char [] charPass = jpfPass.getPassword();
                usrPass = new String(charPass);
                
                pstm.setString(1, jtxfUsuario.getText());
                pstm.setString(2, usrPass);

                java.sql.ResultSet rst = pstm.executeQuery();

                if (rst.next()) {
                    usrNivel    = rst.getInt("usrNivel");
                    usrEstado   = rst.getInt("usrActivo");
                    usrID       = rst.getInt("usrID");
                    
                    DatosGlobales.appSesion = true;
                    DatosGlobales.usrNivel  = usrNivel;
                    DatosGlobales.usrEstado = usrEstado;
                    DatosGlobales.usrEmail  = jtxfUsuario.getText();
                    DatosGlobales.usrID     = usrID;
                    
                    if(DatosGlobales.usrNivel == 1 && DatosGlobales.usrEstado == 1 && DatosGlobales.appSesion) {
                        VistaActividadAdmin vistaAdmin = new VistaActividadAdmin();
                        AppPrincipal.desktopPane.add(vistaAdmin);
                        vistaAdmin.toFront();
                        vistaAdmin.show();
                        AppPrincipal.admMenu.setEnabled(true);
                    } else {
                        if(DatosGlobales.usrNivel == 2 && DatosGlobales.usrEstado == 0) {
                            AppPrincipal.propMenu.setEnabled(true);
                        }
                    }
                    
                    AppPrincipal.jlblAppUsuario.setText(DatosGlobales.usrEmail);
                                        
                    JOptionPaneConTimeOut.visualizaDialogo(this, "Bienvenido: " + DatosGlobales.usrEmail, "Bienvenido al Sistema", 2000);

                    dispose();
                    
                } else {
                    javax.swing.JOptionPane.showMessageDialog(this, "Contraseña Incorrecta.", "Error Contraseña", javax.swing.JOptionPane.ERROR_MESSAGE);
                }

                cnx.close();
            /*
            } catch (ClassNotFoundException cnfe) {
                javax.swing.JOptionPane.showMessageDialog(this, cnfe.getMessage(), "Error ClassNotFound", javax.swing.JOptionPane.ERROR_MESSAGE);
            */
            } catch (java.sql.SQLException sqle) {
                javax.swing.JOptionPane.showMessageDialog(this, sqle.getMessage(), "Error SQL", javax.swing.JOptionPane.ERROR_MESSAGE);
            }
        }    
    }//GEN-LAST:event_jbtnLoginActionPerformed

    private void jbtnRegistrarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbtnRegistrarActionPerformed
        NuevoUsuario nUsr = new NuevoUsuario();
           AppPrincipal.desktopPane.add(nUsr);
           nUsr.toFront();
           nUsr.show();
           dispose();
    }//GEN-LAST:event_jbtnRegistrarActionPerformed

    private void jbtnCancelarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbtnCancelarActionPerformed
        dispose();
    }//GEN-LAST:event_jbtnCancelarActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jbtnCancelar;
    private javax.swing.JButton jbtnLogin;
    private javax.swing.JButton jbtnRegistrar;
    private javax.swing.JLabel jlblPass;
    private javax.swing.JLabel jlblUsuario;
    private javax.swing.JPasswordField jpfPass;
    private javax.swing.JTextField jtxfUsuario;
    // End of variables declaration//GEN-END:variables
}
