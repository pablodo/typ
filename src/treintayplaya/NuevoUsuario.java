/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * NuevoUsuario.java
 *
 * Created on 11-oct-2011, 10:58:41
 */
package treintayplaya;

import java.sql.SQLException;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 *
 * @author pablo
 */
public class NuevoUsuario extends javax.swing.JInternalFrame {
    private int id;
    private boolean actualizar;
    private java.sql.Connection cnx;
    private ConsultaUsuarios consultaUsuarios = null;

    /** Creates new form NuevoUsuario */
    public NuevoUsuario(ConsultaUsuarios consultaUsuarios) {
        cnx = Conexion.getInstance().cnx;
        this.id = 0;
        this.consultaUsuarios = consultaUsuarios;
        if (consultaUsuarios != null){
            int row = consultaUsuarios.jtblUsuarios.getSelectedRow();
            if (consultaUsuarios.ids.size() >= row && row >= 0)
                this.id = consultaUsuarios.ids.get(row);
        }
        actualizar = id > 0;
        initComponents();
		Funciones.cargarComboTablaApellidoNombre(jcbxPropietario, 
												 "SELECT * FROM Propietarios",
												 "propApellido", "propNombre", 
												 "propID", true);
        if (actualizar){
            cargarUsuario();
        }
    }

    public NuevoUsuario() {
        this(null);
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jlblUsuario = new javax.swing.JLabel();
        jlblPass = new javax.swing.JLabel();
        jlblValPass = new javax.swing.JLabel();
        jtxfUsuario = new javax.swing.JTextField();
        jpfPass = new javax.swing.JPasswordField();
        jpfValPass = new javax.swing.JPasswordField();
        jbtnCancelar = new javax.swing.JButton();
        jbtnAceptar = new javax.swing.JButton();
        jchkAdmin = new javax.swing.JCheckBox();
        lblPropietario = new javax.swing.JLabel();
        jcbxPropietario = new treintayplaya.ComboTabla();

        setClosable(true);
        setMaximizable(true);
        setResizable(true);
        setTitle("Registro de Usuario Nuevo");

        jlblUsuario.setText("Usuario:");

        jlblPass.setText("Contraseña:");

        jlblValPass.setText("Valida Contraseña:");

        jbtnCancelar.setText("Cancelar");
        jbtnCancelar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbtnCancelarActionPerformed(evt);
            }
        });

        jbtnAceptar.setText("Aceptar");
        jbtnAceptar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbtnAceptarActionPerformed(evt);
            }
        });

        jchkAdmin.setText("Administrador?");
        jchkAdmin.setEnabled(AppPrincipal.isAdmin());
        jchkAdmin.setVisible(AppPrincipal.isAdmin());

        lblPropietario.setText("Propietario:");

        org.jdesktop.layout.GroupLayout layout = new org.jdesktop.layout.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(layout.createSequentialGroup()
                .addContainerGap()
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                    .add(layout.createSequentialGroup()
                        .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING, false)
                            .add(jlblValPass, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .add(jlblPass, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .add(jlblUsuario, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .add(lblPropietario))
                        .add(18, 18, 18)
                        .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                            .add(jpfValPass, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 362, Short.MAX_VALUE)
                            .add(jtxfUsuario, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 362, Short.MAX_VALUE)
                            .add(jpfPass, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 362, Short.MAX_VALUE)
                            .add(jcbxPropietario, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                    .add(org.jdesktop.layout.GroupLayout.TRAILING, layout.createSequentialGroup()
                        .add(0, 0, Short.MAX_VALUE)
                        .add(jbtnAceptar)
                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                        .add(jbtnCancelar))
                    .add(layout.createSequentialGroup()
                        .add(jchkAdmin)
                        .add(0, 0, Short.MAX_VALUE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(layout.createSequentialGroup()
                .addContainerGap()
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.CENTER)
                    .add(jtxfUsuario, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                    .add(jlblUsuario))
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.CENTER)
                    .add(jpfPass, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                    .add(jlblPass))
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.CENTER)
                    .add(jpfValPass, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                    .add(jlblValPass))
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jcbxPropietario, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                    .add(lblPropietario))
                .add(16, 16, 16)
                .add(jchkAdmin)
                .add(6, 6, 6)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jbtnCancelar)
                    .add(jbtnAceptar))
                .addContainerGap(13, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jbtnCancelarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbtnCancelarActionPerformed
        dispose();
    }//GEN-LAST:event_jbtnCancelarActionPerformed

    private void jbtnAceptarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jbtnAceptarActionPerformed
        boolean valEmail, valPass;

        valEmail = valPass = false;

        // Valida Dirección de E-Mail
        if(!validaEmail(jtxfUsuario.getText())) {
            javax.swing.JOptionPane.showMessageDialog(this,
                                                      "Ingresó una Dirección de Correo Electrónico NO Válido.",
                                                      "Error",
                                                      javax.swing.JOptionPane.ERROR_MESSAGE);
            jtxfUsuario.setText("");
            jtxfUsuario.requestFocus();
        } else {
            valEmail = true;
        }

        // Valida Pass
        if(!validaPass(new String(jpfPass.getPassword()), new String(jpfValPass.getPassword()))) {
            javax.swing.JOptionPane.showMessageDialog(this,
                                                      "Las Contraseñas NO Coinciden.",
                                                      "Error",
                                                      javax.swing.JOptionPane.ERROR_MESSAGE);
            jpfPass.setText("");
            jpfValPass.setText("");
            jpfPass.requestFocus();
        } else {
            valPass = true;
        }

        // Agregar el Usuario a la Base
        if(valEmail && valPass) {
            try {
                java.sql.Connection cnx = Conexion.getInstance().getConnection();

                String query = "INSERT INTO UsuariosWeb (usrEmail, usrPass, usrNivel, usrPropID, usrActivo) " + 
							   "VALUES (?,AES_ENCRYPT(?, 'typ2012'),?,?,?)";
                String mensaje = "El usuario se registró correctamente.";
                if (actualizar){
                    query = "UPDATE UsuariosWeb SET usrEmail=?, usrPass=AES_ENCRYPT(?,'typ2012'), "
							+ "usrNivel=?, usrActivo=1, usrPropID=? WHERE usrID=?";
                    mensaje = "El usuario se actualizó correctamente.";
                }
                java.sql.PreparedStatement pstm = cnx.prepareStatement(query);

                pstm.setString(1, jtxfUsuario.getText());
                pstm.setString(2, String.valueOf(jpfPass.getPassword()));
                pstm.setInt(3, jchkAdmin.isSelected()?1:2);
				pstm.setInt(4, jcbxPropietario.getSelectedId());
                if (! actualizar)
                    pstm.setInt(5, 1);
                else
                    pstm.setInt(5, id);
				
                int resultado = pstm.executeUpdate();

                javax.swing.JOptionPane.showMessageDialog(this, mensaje, "Registro", javax.swing.JOptionPane.INFORMATION_MESSAGE);

                pstm.close();
            } catch (java.sql.SQLException sqle) {
                javax.swing.JOptionPane.showMessageDialog(this, sqle.getMessage(), "Error", javax.swing.JOptionPane.ERROR_MESSAGE);
            }
            if (consultaUsuarios != null)
                consultaUsuarios.cargaTabla();
            dispose();
        }
    }//GEN-LAST:event_jbtnAceptarActionPerformed

    private boolean validaEmail(String email) {
        boolean resultado = false;
        int contAT = 0;
        int posAT = 0;
        int contPunto = 0;
        
        for(int i = 0; i < email.length(); i++)
            if(email.charAt(i) == '@') {
                contAT++;
                posAT = i;
            }
        
        for(int i = posAT; i < email.length(); i++)    
            if(email.charAt(i) == '.')
                contPunto++;
        
        
        if(contAT == 1 && contPunto >= 1)
            resultado = true;
        
        return resultado;
    }
    
    private boolean validaPass(String pass, String passVal) {
        if(pass.trim().matches(""))
            return false;
        if(! pass.matches(passVal))
            return false;
        return true;
    }
    
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jbtnAceptar;
    private javax.swing.JButton jbtnCancelar;
    private treintayplaya.ComboTabla jcbxPropietario;
    private javax.swing.JCheckBox jchkAdmin;
    private javax.swing.JLabel jlblPass;
    private javax.swing.JLabel jlblUsuario;
    private javax.swing.JLabel jlblValPass;
    private javax.swing.JPasswordField jpfPass;
    private javax.swing.JPasswordField jpfValPass;
    private javax.swing.JTextField jtxfUsuario;
    private javax.swing.JLabel lblPropietario;
    // End of variables declaration//GEN-END:variables

    private void cargarUsuario() {
        String query = "SELECT * FROM UsuariosWeb WHERE usrID=?";
        try {
            java.sql.PreparedStatement pstm =  cnx.prepareStatement(query);
            pstm.setInt(1, id);
            java.sql.ResultSet rst = pstm.executeQuery();
            rst.next();
            jtxfUsuario.setText(rst.getString("usrEmail"));
            jchkAdmin.setSelected(rst.getInt("usrNivel")==1);
			jcbxPropietario.setSelectedItemById(rst.getInt("usrPropID"));
            rst.close();
            pstm.close();
        } catch (SQLException ex) {
            Logger.getLogger(NuevoUsuario.class.getName()).log(Level.SEVERE, null, ex);
        }
    }
}
